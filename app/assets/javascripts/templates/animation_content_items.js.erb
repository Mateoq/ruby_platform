prTemplates.directive('animationContentItems', ['updateProgressService', '$timeout', function (updateProgressService, $timeout) {
	return {
		templateUrl: 'animation_content_items.html',
		restrict: 'E',
		transclude: true,
		scope: {
			options: '=options'
		},
		link: function postLink(scope, iElement, iAttrs) {
			scope.options.templateClass = 'animation-content-items';

			var itemsCount = 0,
				itemsProgress = 0;

			angular.forEach(scope.options.items, function(value, key){
				angular.forEach(value, function(item, k){
					itemsCount++;
					scope.options.items[key][k].contentMainClass = "item-" + itemsCount;

					if (item.event) {
						scope.hasEvent = true;
						item.onAnimation = function ($event, item) {
							if (item.done) { return; }
							
							itemsProgress++;

							item.done = true;

							if (itemsProgress === itemsCount) {
								localUpdateProgress();
							}
						};
					}

					if (scope.options.done) {
						item.done = true;
					}
				});
			});

			console.log(scope.options.items);

			$timeout(function () {
				if (!scope.options.done && !scope.hasEvent) {
					localUpdateProgress();
				}
			}, 5000);

			$timeout(function () {
				if (scope.hasEvent) Gifffer();
			}, 600);

			function localUpdateProgress () {
				updateProgressService(
	                gon.course_structure.class_name,
	                gon.course_structure.grade,
	                gon.course_structure.lesson_guide,
	                gon.course_structure.lesson_num
	            );

	            updateProgressService.update(gon.lesson_structure[scope.$root.routeIndex].url_name, scope.$root.nextItem).then(function (data) {
	            	// TODO: congrats message
	            	scope.$root.lessonProgress = data.lesson_progress[gon.course_app];
	            	scope.$root.isNextEnabled = true;
	            });
			}
		}
	};
}])